<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Integrated Screening LCA–TEA Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg1:#1e3c72;
  --bg2:#2a5298;
  --glass: rgba(255,255,255,0.10);
  --glass2: rgba(255,255,255,0.16);
  --text: rgba(255,255,255,0.95);
  --muted: rgba(255,255,255,0.78);
  --warn: rgba(255,205,86,0.22);
  --bad: rgba(255,99,132,0.20);
  --good: rgba(75,192,192,0.18);
  --shadow: 0 12px 35px rgba(0,0,0,0.25);
}
*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background:
    radial-gradient(1200px 800px at 20% 20%, rgba(255,255,255,0.10), transparent 55%),
    radial-gradient(1200px 800px at 80% 70%, rgba(255,255,255,0.10), transparent 55%),
    linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}
header{
  padding:18px 18px 10px;
  text-align:center;
  font-size:22px;
  font-weight:800;
  letter-spacing:0.3px;
  background:rgba(0,0,0,0.20);
  border-bottom:1px solid rgba(255,255,255,0.10);
  position:sticky;
  top:0;
  z-index:10;
  backdrop-filter: blur(10px);
}
.subhead{
  font-size:12px;
  font-weight:700;
  color:rgba(255,255,255,0.80);
  margin-top:6px;
}
nav{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:14px 14px 6px;
  flex-wrap:wrap;
}
nav button{
  background: rgba(255,255,255,0.92);
  color:#1e3c72;
  border:none;
  padding:10px 18px;
  border-radius:999px;
  cursor:pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
  box-shadow: 0 8px 18px rgba(0,0,0,0.18);
  font-weight:800;
}
nav button:hover{ transform: translateY(-1px) scale(1.03); }
nav button:active{ transform: translateY(1px) scale(0.98); opacity:0.9; }
nav button.active{
  background: rgba(255,255,255,1);
  box-shadow: 0 14px 25px rgba(0,0,0,0.28);
}
.container{
  max-width:1100px;
  margin: 0 auto;
  padding: 10px 16px 28px;
}
.page{
  display:none;
  opacity:0;
  transform: translateY(10px);
  transition: opacity 220ms ease, transform 220ms ease;
  will-change: opacity, transform;
}
.page.active{ display:block; }
.page.visible{
  opacity:1;
  transform: translateY(0);
}
.card{
  background:var(--glass);
  backdrop-filter: blur(12px);
  border-radius:18px;
  padding:18px;
  margin:14px 0;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,0.12);
  transition: transform 160ms ease, background 160ms ease, border-color 160ms ease;
  animation: cardIn 340ms ease both;
}
.card:hover{
  transform: translateY(-3px);
  background: var(--glass2);
  border-color: rgba(255,255,255,0.18);
}
@keyframes cardIn{
  from{ opacity:0; transform: translateY(10px); }
  to{ opacity:1; transform: translateY(0); }
}
h3{ margin: 0 0 10px; }
.small{ font-size:12px; color:var(--muted); line-height:1.35; }
.kpi{
  font-size:20px;
  font-weight:900;
  margin-top:10px;
  display:flex;
  align-items:baseline;
  gap:10px;
  flex-wrap:wrap;
}
.kpi .pill{
  font-size:12px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(0,0,0,0.22);
  border:1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.92);
}
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  gap:12px;
}
label{
  font-size:13px;
  color: rgba(255,255,255,0.92);
  display:block;
  margin-bottom:6px;
  font-weight:800;
}
.field{
  background: rgba(0,0,0,0.16);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:14px;
  padding:12px;
  transition: transform 140ms ease, border-color 140ms ease, background 140ms ease;
}
.field:hover{
  transform: translateY(-1px);
  border-color: rgba(255,255,255,0.20);
  background: rgba(0,0,0,0.18);
}
input, select{
  width:100%;
  padding:10px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.10);
  color:var(--text);
  outline:none;
  font-weight:800;
}
input:focus, select:focus{
  border-color: rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.14);
}
.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.actions button{
  background: rgba(255,255,255,0.95);
  color:#1e3c72;
  border:none;
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  transition: transform 140ms ease, box-shadow 140ms ease, opacity 140ms ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.20);
}
.actions button:hover{ transform: translateY(-1px); box-shadow: 0 14px 25px rgba(0,0,0,0.26); }
.actions button:active{ transform: translateY(1px); opacity:0.9; }

hr.sep{
  border:none;
  height:1px;
  background:rgba(255,255,255,0.18);
  margin:18px 0;
}
canvas{
  background:white;
  border-radius:16px;
  padding:10px;
  margin-top:10px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.14);
  margin-top:8px;
  font-size:12px;
  font-weight:900;
}
.badge.good{ background: var(--good); }
.badge.warn{ background: var(--warn); }
.badge.bad{ background: var(--bad); }

.toast{
  position: fixed;
  bottom: 14px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(0,0,0,0.70);
  border: 1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.95);
  padding: 10px 14px;
  border-radius: 999px;
  font-size: 13px;
  opacity: 0;
  pointer-events:none;
  transition: opacity 220ms ease, transform 220ms ease;
  backdrop-filter: blur(10px);
  z-index:999;
}
.toast.show{
  opacity:1;
  transform: translateX(-50%) translateY(0);
}
details{
  background: rgba(0,0,0,0.14);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:14px;
  padding:12px;
}
details summary{
  cursor:pointer;
  font-weight:900;
}
details .small{ margin-top:8px; }

@media (prefers-reduced-motion: reduce){
  *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
}
</style>
</head>

<body>
<header>
  Integrated Screening LCA–TEA Dashboard
  <div class="subhead">Cradle-to-gate (configurable) • Results reported per Functional Unit (FU)</div>
</header>

<nav>
  <button id="tab-scope" onclick="showPage('scope')">Scope</button>
  <button id="tab-lca" onclick="showPage('lca')">LCA</button>
  <button id="tab-tea" onclick="showPage('tea')">TEA</button>
  <button id="tab-sensitivity" onclick="showPage('sensitivity')">Sensitivity</button>
  <button id="tab-summary" onclick="showPage('summary')">Summary</button>
</nav>

<div class="container">

  <!-- SCOPE -->
  <div id="scope" class="page active">
    <div class="card">
      <h3>Model Scope</h3>
      <div class="grid">
        <div class="field">
          <label>Functional Unit (FU) label</label>
          <input id="fuLabel" value="1 t primary product at plant gate">
          <div class="small">Free text label. Use “1 kg” or “1 MJ” if that is your convention.</div>
        </div>

        <div class="field">
          <label>System boundary</label>
          <select id="boundary">
            <option value="cradle_to_gate" selected>Cradle-to-gate (feedstock → plant gate)</option>
            <option value="gate_to_gate">Gate-to-gate (process only)</option>
            <option value="custom">Custom (document assumptions)</option>
          </select>
          <div class="small">This dashboard is screening-level. Keep boundary consistent across comparisons.</div>
        </div>

        <div class="field">
          <label>Co-product handling</label>
          <select id="coproductMethod">
            <option value="none" selected>No co-product credit/allocation</option>
            <option value="energy_credit">Energy export credit (electricity/heat only)</option>
            <option value="allocation_note">Allocation noted externally (not computed here)</option>
          </select>
          <div class="small">This tool credits exported energy. Co-product allocation is documented, not solved.</div>
        </div>

        <div class="field">
          <label>Units convention</label>
          <select id="unitMode">
            <option value="t" selected>Mass flows in tonnes (t/FU)</option>
            <option value="kg">Mass flows in kilograms (kg/FU)</option>
          </select>
          <div class="small">Choose one and stay consistent.</div>
        </div>
      </div>

      <details style="margin-top:12px;">
        <summary>Method notes (screening-level)</summary>
        <div class="small">
          • LCA: transport + electricity + heat + waste treatment − exported-energy credits (kg CO₂e per FU).<br>
          • TEA: discounted cash flow NPV using user inputs; optional simple CAPEX schedule and OPEX breakdown.<br>
          • A mass-balance consistency check flags missing or inconsistent inventory entries.
        </div>
      </details>
    </div>
  </div>

  <!-- LCA -->
  <div id="lca" class="page">
    <div class="card">
      <h3>System Inventory (per FU)</h3>

      <div class="grid">
        <div class="field">
          <label>Feedstock in</label>
          <input id="feedIn" inputmode="decimal" value="3">
          <div class="small">Mass of biomass/feedstock entering the process (t/FU or kg/FU).</div>
        </div>

        <div class="field">
          <label>Main product out</label>
          <input id="prodOut" inputmode="decimal" value="1">
          <div class="small">Mass of primary product at plant gate.</div>
        </div>

        <div class="field">
          <label>Co-product out</label>
          <input id="coprodOut" inputmode="decimal" value="0">
          <div class="small">Optional secondary product mass; set 0 if none.</div>
        </div>

        <div class="field">
          <label>Solid waste out</label>
          <input id="wSolid" inputmode="decimal" value="0.2">
          <div class="small">E.g., ash, char, sludge cake.</div>
        </div>

        <div class="field">
          <label>Liquid waste out</label>
          <input id="wLiquid" inputmode="decimal" value="0.1">
          <div class="small">TOTAL liquid waste mass (e.g., wastewater, purge).</div>
        </div>

        <div class="field">
          <label>Gaseous waste out</label>
          <input id="wGas" inputmode="decimal" value="0.05">
          <div class="small">TOTAL gas waste mass vented/treated (not product gas).</div>
        </div>

        <div class="field">
          <label>Added water / moisture in</label>
          <input id="waterIn" inputmode="decimal" value="0">
          <div class="small">Make-up water, moisture, solvents counted as water-equivalent.</div>
        </div>

        <div class="field">
          <label>Air in (optional)</label>
          <input id="airIn" inputmode="decimal" value="0">
          <div class="small">Only for inventory consistency (combustion/oxidation air tracking).</div>
        </div>

        <div class="field">
          <label>Evaporated water out</label>
          <input id="waterVaporOut" inputmode="decimal" value="0">
          <div class="small">Water leaving as vapor (drying, vents, evaporation).</div>
        </div>

        <div class="field">
          <label>CO₂ to air out (inventory)</label>
          <input id="co2Out" inputmode="decimal" value="0">
          <div class="small">Inventory mass only; not automatically treated as fossil GHG.</div>
        </div>
      </div>

      <hr class="sep">

      <h3>Energy + Logistics (per FU)</h3>
      <div class="grid">
        <div class="field">
          <label>Transport distance (km)</label>
          <input id="km" inputmode="decimal" value="120">
        </div>

        <div class="field">
          <label>Truck EF (kg CO₂e/(mass·km))</label>
          <input id="truckEF" inputmode="decimal" value="0.12">
          <div class="small">If your mass unit is t, EF is kg CO₂e/(t·km). If kg, use kg CO₂e/(kg·km).</div>
        </div>

        <div class="field">
          <label>Electricity in (kWh/FU)</label>
          <input id="elecIn" inputmode="decimal" value="900">
        </div>

        <div class="field">
          <label>Grid EF (kg CO₂e/kWh)</label>
          <input id="gridEF" inputmode="decimal" value="0.35">
        </div>

        <div class="field">
          <label>Heat/Steam in (MJ/FU)</label>
          <input id="heatIn" inputmode="decimal" value="0">
        </div>

        <div class="field">
          <label>Heat EF (kg CO₂e/MJ)</label>
          <input id="heatEF" inputmode="decimal" value="0.07">
        </div>

        <div class="field">
          <label>Exported electricity (kWh/FU)</label>
          <input id="elecOut" inputmode="decimal" value="0">
          <div class="small">Credit uses Grid EF.</div>
        </div>

        <div class="field">
          <label>Exported heat (MJ/FU)</label>
          <input id="heatOut" inputmode="decimal" value="0">
          <div class="small">Credit uses Heat EF.</div>
        </div>
      </div>

      <hr class="sep">

      <h3>Waste Treatment Emission Factors</h3>
      <div class="grid">
        <div class="field">
          <label>Solid waste EF (kg CO₂e/mass)</label>
          <input id="efSolid" inputmode="decimal" value="50">
        </div>

        <div class="field">
          <label>Liquid waste EF (kg CO₂e/mass)</label>
          <input id="efLiquid" inputmode="decimal" value="30">
        </div>

        <div class="field">
          <label>Gas waste EF (kg CO₂e/mass)</label>
          <input id="efGas" inputmode="decimal" value="200">
        </div>
      </div>

      <div class="actions">
        <button onclick="runLCA()">Run LCA</button>
        <button onclick="quickScenario('low')">Low-impact scenario</button>
        <button onclick="quickScenario('high')">High-impact scenario</button>
      </div>

      <div id="lcaKPI" class="kpi"></div>
      <div id="lcaMassCheck" class="small"></div>
      <div id="lcaMassBadge"></div>

      <details style="margin-top:12px;">
        <summary>Interpretation notes</summary>
        <div class="small">
          • Results are screening-level comparisons, not ISO-compliant LCA.<br>
          • Credits only apply to exported electricity/heat (displacement via EF).<br>
          • Document EFs (grid, waste, heat) and keep them consistent across scenarios.
        </div>
      </details>
    </div>

    <div class="card">
      <h3>GHG Contribution (kg CO₂e per FU)</h3>
      <canvas id="lcaChart"></canvas>
      <div id="lcaSliceInfo" class="small"></div>
    </div>

    <div class="card">
      <h3>Inventory Overview</h3>
      <div class="small">Mixed units; this is an inventory snapshot, not a process solver.</div>
      <canvas id="flowChart"></canvas>
    </div>
  </div>

  <!-- TEA -->
  <div id="tea" class="page">
    <div class="card">
      <h3>TEA Inputs (Discounted Cash Flow)</h3>

      <div class="grid">
        <div class="field">
          <label>Project life (years)</label>
          <input id="life" inputmode="numeric" value="15">
        </div>

        <div class="field">
          <label>Discount rate (%)</label>
          <input id="discount" inputmode="decimal" value="8">
        </div>

        <div class="field">
          <label>CAPEX (total, $)</label>
          <input id="capex" inputmode="decimal" value="5000000">
          <div class="small">Total capital investment. (Optional) spread via CAPEX schedule below.</div>
        </div>

        <div class="field">
          <label>CAPEX spend year 0 (%)</label>
          <input id="capexY0" inputmode="decimal" value="100">
          <div class="small">Remainder is spent in year 1 (simple 2-year schedule).</div>
        </div>

        <div class="field">
          <label>Annual production (FU/year)</label>
          <input id="annualFU" inputmode="decimal" value="1">
          <div class="small">Used to connect per-FU LCA to annual totals; TEA uses $/year inputs below.</div>
        </div>

        <div class="field">
          <label>Inflation / escalation (%)</label>
          <input id="inflation" inputmode="decimal" value="0">
          <div class="small">Applies to revenue and OPEX annually (set 0 if not used).</div>
        </div>
      </div>

      <hr class="sep">

      <h3>Annual Revenue + OPEX (simple breakdown)</h3>
      <div class="grid">
        <div class="field">
          <label>Product revenue ($/year)</label>
          <input id="revProduct" inputmode="decimal" value="2000000">
        </div>

        <div class="field">
          <label>Co-product revenue ($/year)</label>
          <input id="revCoprod" inputmode="decimal" value="0">
        </div>

        <div class="field">
          <label>Feedstock cost ($/year)</label>
          <input id="opFeed" inputmode="decimal" value="600000">
        </div>

        <div class="field">
          <label>Utilities ($/year)</label>
          <input id="opUtil" inputmode="decimal" value="250000">
        </div>

        <div class="field">
          <label>Labor + overhead ($/year)</label>
          <input id="opLabor" inputmode="decimal" value="200000">
        </div>

        <div class="field">
          <label>Maintenance + other ($/year)</label>
          <input id="opMaint" inputmode="decimal" value="150000">
        </div>
      </div>

      <div class="actions">
        <button onclick="runTEA()">Run TEA</button>
      </div>
      <div id="teaKPI" class="kpi"></div>

      <details style="margin-top:12px;">
        <summary>Economic model assumptions</summary>
        <div class="small">
          • Simple DCF NPV: cashflows discounted at r over project life.<br>
          • CAPEX schedule: year 0 and year 1 only (screening approximation).<br>
          • Inflation applies uniformly to revenue and OPEX components if enabled.
        </div>
      </details>
    </div>

    <div class="card">
      <h3>Cashflow ($/year)</h3>
      <canvas id="teaChart"></canvas>
      <div id="teaClickInfo" class="small"></div>
    </div>
  </div>

  <!-- SENSITIVITY -->
  <div id="sensitivity" class="page">
    <div class="card">
      <h3>One-Parameter Sensitivity (± range)</h3>
      <div class="small">
        This runs a quick parametric sweep (screening). It varies one driver while holding others constant.
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="field">
          <label>Parameter</label>
          <select id="sensParam">
            <option value="gridEF" selected>Grid EF (kg CO₂e/kWh)</option>
            <option value="truckEF">Truck EF (kg CO₂e/(mass·km))</option>
            <option value="km">Transport distance (km)</option>
            <option value="efGas">Gas waste EF (kg CO₂e/mass)</option>
            <option value="discount">Discount rate (%)</option>
            <option value="revProduct">Product revenue ($/year)</option>
            <option value="opFeed">Feedstock cost ($/year)</option>
          </select>
        </div>

        <div class="field">
          <label>Range (±%)</label>
          <input id="sensRange" inputmode="decimal" value="30">
        </div>

        <div class="field">
          <label>Steps</label>
          <input id="sensSteps" inputmode="numeric" value="9">
        </div>
      </div>

      <div class="actions">
        <button onclick="runSensitivity()">Run sensitivity</button>
      </div>

      <div class="small" id="sensNote"></div>
    </div>

    <div class="card">
      <h3>Sensitivity Results</h3>
      <canvas id="sensChart"></canvas>
      <div class="small" id="sensClickInfo"></div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="summary" class="page">
    <div class="card">
      <h3>Integrated Results</h3>
      <div class="small" id="scopeLine"></div>
      <div id="summaryResults" class="kpi"></div>
      <div id="summaryExtras" class="small"></div>
    </div>

    <div class="card">
      <h3>Documentation checklist</h3>
      <div class="small">
        • Functional Unit definition (what “1 FU” means).<br>
        • System boundary (cradle-to-gate vs gate-to-gate).<br>
        • Emission factor sources (grid, heat, transport, waste).<br>
        • Co-product handling approach (credits vs allocation).<br>
        • Economic assumptions (CAPEX basis, discount rate, escalation).
      </div>
    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
let appState = {}
let lcaChart = null
let teaChart = null
let flowChart = null
let sensChart = null

function num(id){
  const el = document.getElementById(id)
  if(!el) return 0
  const v = parseFloat(el.value)
  return Number.isFinite(v) ? v : 0
}
function intNum(id){
  const el = document.getElementById(id)
  if(!el) return 0
  const v = parseInt(el.value || "0", 10)
  return Number.isFinite(v) ? v : 0
}
function money(x){
  const sign = x < 0 ? "-" : ""
  const a = Math.abs(x)
  return sign + "$" + a.toLocaleString(undefined,{maximumFractionDigits:0})
}
function setActiveTab(id){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"))
  const tab = document.getElementById("tab-"+id)
  if(tab) tab.classList.add("active")
}
function showPage(id){
  setActiveTab(id)
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active','visible'))
  const page = document.getElementById(id)
  page.classList.add('active')
  requestAnimationFrame(()=>page.classList.add('visible'))
  updateSummary()
}
function toast(msg){
  const t = document.getElementById("toast")
  t.textContent = msg
  t.classList.add("show")
  clearTimeout(toast._timer)
  toast._timer = setTimeout(()=>t.classList.remove("show"), 1800)
}
/* Animated count-up for KPI numbers inside a string containing a number */
function animateKPI(el, newText, durationMs=650){
  const prev = el.textContent || ""
  const mNew = newText.match(/(-?\d+(\.\d+)?)/)
  const mOld = prev.match(/(-?\d+(\.\d+)?)/)
  if(!mNew){ el.textContent = newText; return }
  const target = parseFloat(mNew[1])
  const start = mOld ? parseFloat(mOld[1]) : 0
  const prefix = newText.slice(0, mNew.index)
  const suffix = newText.slice(mNew.index + mNew[1].length)
  const t0 = performance.now()
  function step(t){
    const u = Math.min(1, (t - t0)/durationMs)
    const eased = 1 - Math.pow(1-u, 3)
    const val = start + (target - start)*eased
    const txt = prefix + (suffix.includes("$") ? Math.round(val) : val.toFixed(1)) + suffix
    el.textContent = txt
    if(u < 1) requestAnimationFrame(step)
  }
  requestAnimationFrame(step)
}

function getMassUnitMode(){
  return document.getElementById("unitMode").value // "t" or "kg"
}
function massUnitLabel(){
  return getMassUnitMode() === "kg" ? "kg" : "t"
}

/* ---------------- LCA ---------------- */
function runLCA(){
  const unit = getMassUnitMode()

  // Mass flows (unit/FU)
  const feedIn    = num("feedIn")
  const prodOut   = num("prodOut")
  const coprodOut = num("coprodOut")
  const wSolid    = num("wSolid")
  const wLiquid   = num("wLiquid")
  const wGas      = num("wGas")
  const waterIn       = num("waterIn")
  const airIn         = num("airIn")
  const waterVaporOut = num("waterVaporOut")
  const co2Out        = num("co2Out")

  // Logistics + energy
  const km      = num("km")
  const truckEF = num("truckEF")
  const elecIn  = num("elecIn")
  const gridEF  = num("gridEF")
  const heatIn  = num("heatIn")
  const heatEF  = num("heatEF")
  const elecOut = num("elecOut")
  const heatOut = num("heatOut")

  // Waste treatment EFs (kg CO2e/unit waste)
  const efSolid  = num("efSolid")
  const efLiquid = num("efLiquid")
  const efGas    = num("efGas")

  // Consistency checks
  if(prodOut <= 0){
    toast("Main product out must be > 0")
    return
  }
  if(km < 0 || elecIn < 0 || heatIn < 0){
    toast("Energy/logistics inputs must be ≥ 0")
    return
  }

  // Screening GHG (kg CO2e per FU)
  // transport EF is expressed per (mass·km) where mass uses the selected unit.
  const transport_kg = feedIn * km * truckEF
  const elecIn_kg    = elecIn * gridEF
  const heatIn_kg    = heatIn * heatEF

  const wasteSolid_kg  = wSolid  * efSolid
  const wasteLiquid_kg = wLiquid * efLiquid
  const wasteGas_kg    = wGas    * efGas

  const credits_kg = (elecOut * gridEF) + (heatOut * heatEF)

  const gross_kg = transport_kg + elecIn_kg + heatIn_kg + wasteSolid_kg + wasteLiquid_kg + wasteGas_kg
  const net_kg = gross_kg - credits_kg

  appState.lca = {
    net_kg, gross_kg,
    breakdown: {
      Transport: transport_kg,
      Electricity_in: elecIn_kg,
      Heat_in: heatIn_kg,
      Solid_waste: wasteSolid_kg,
      Liquid_waste: wasteLiquid_kg,
      Gas_waste: wasteGas_kg,
      Energy_credits: -credits_kg
    },
    flows: {
      feedIn, prodOut, coprodOut, wSolid, wLiquid, wGas,
      waterIn, airIn, waterVaporOut, co2Out,
      elecIn, heatIn, elecOut, heatOut
    }
  }

  // Mass check (screening) + flagging
  const massIn  = feedIn + waterIn + airIn
  const massOut = prodOut + coprodOut + wSolid + wLiquid + wGas + waterVaporOut + co2Out
  const massDelta = massIn - massOut
  const pct = massIn !== 0 ? (massDelta / massIn) * 100 : 0

  const kpiEl = document.getElementById("lcaKPI")
  animateKPI(kpiEl, `Net GHG: ${net_kg.toFixed(1)} kg CO₂e/FU`)
  document.getElementById("lcaMassCheck").textContent =
    `Mass check (screening): in ${massIn.toFixed(3)} ${unit}/FU vs out ${massOut.toFixed(3)} ${unit}/FU (Δ = ${massDelta.toFixed(3)} ${unit}, ${pct.toFixed(1)}%).`

  const badgeHost = document.getElementById("lcaMassBadge")
  badgeHost.innerHTML = ""
  const absPct = Math.abs(pct)
  let cls="good", txt="Mass balance: OK (screening)"
  if(massIn === 0){
    cls="warn"; txt="Mass balance: not evaluated (mass in = 0)"
  } else if(absPct > 10){
    cls="bad"; txt="Mass balance: HIGH mismatch — inventory likely incomplete"
  } else if(absPct > 3){
    cls="warn"; txt="Mass balance: moderate mismatch — review inputs"
  }
  const badge = document.createElement("div")
  badge.className = `badge ${cls}`
  badge.textContent = txt
  badgeHost.appendChild(badge)

  drawLCAChart(appState.lca.breakdown)
  drawFlowChart(appState.lca.flows)

  toast("LCA updated")
  updateSummary()
}

function drawLCAChart(breakdown){
  if(lcaChart) lcaChart.destroy()

  const labels = ["Transport","Electricity in","Heat in","Solid waste","Liquid waste","Gas waste","Energy credits"]
  const data = [
    breakdown.Transport,
    breakdown.Electricity_in,
    breakdown.Heat_in,
    breakdown.Solid_waste,
    breakdown.Liquid_waste,
    breakdown.Gas_waste,
    -breakdown.Energy_credits // show magnitude
  ]

  const ctx = document.getElementById("lcaChart").getContext("2d")
  lcaChart = new Chart(ctx,{
    type:'doughnut',
    data:{ labels, datasets:[{ data, borderWidth:0 }] },
    options:{
      responsive:true,
      plugins:{
        legend:{ position:'bottom' },
        tooltip:{ callbacks:{ label:(c)=> `${c.label}: ${c.parsed.toFixed(2)} kg CO₂e/FU` } }
      },
      onClick:(evt, elements)=>{
        const out = document.getElementById("lcaSliceInfo")
        if(!elements || !elements.length){ out.textContent=""; return; }
        const i = elements[0].index
        out.textContent = `${labels[i]} = ${data[i].toFixed(2)} kg CO₂e/FU`
      }
    }
  })
}

function drawFlowChart(flows){
  if(flowChart) flowChart.destroy()
  const u = massUnitLabel()
  const flowLabels = [
    `Feed in (${u})`,`Water in (${u})`,`Air in (${u})`,
    `Product out (${u})`,`Co-product (${u})`,
    `Solid waste (${u})`,`Liquid waste (${u})`,`Gas waste (${u})`,
    `Evap water (${u})`,`CO₂ out (${u})`,
    "Elec in (kWh)","Heat in (MJ)","Elec out (kWh)","Heat out (MJ)"
  ]
  const flowData = [
    flows.feedIn, flows.waterIn, flows.airIn,
    flows.prodOut, flows.coprodOut,
    flows.wSolid, flows.wLiquid, flows.wGas,
    flows.waterVaporOut, flows.co2Out,
    flows.elecIn, flows.heatIn, flows.elecOut, flows.heatOut
  ]
  const ctx = document.getElementById("flowChart").getContext("2d")
  flowChart = new Chart(ctx,{
    type:'bar',
    data:{ labels: flowLabels, datasets:[{ label:'Inventory magnitude (mixed units)', data: flowData }] },
    options:{
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } },
      onClick:(evt, elements)=>{
        if(!elements || !elements.length) return
        const i = elements[0].index
        toast(`${flowLabels[i]}: ${flowData[i]}`)
      }
    }
  })
}

function quickScenario(which){
  if(which === 'low'){
    document.getElementById("gridEF").value = "0.15"
    document.getElementById("km").value = "50"
    document.getElementById("efGas").value = "100"
    toast("Loaded low-impact assumptions")
  }else{
    document.getElementById("gridEF").value = "0.55"
    document.getElementById("km").value = "250"
    document.getElementById("efGas").value = "400"
    toast("Loaded high-impact assumptions")
  }
  runLCA()
}

/* ---------------- TEA ---------------- */
function runTEA(){
  const life = Math.max(1, intNum("life"))
  const r = Math.max(0, num("discount"))/100
  const inflation = num("inflation")/100

  const capex = num("capex")
  const capexY0 = Math.min(100, Math.max(0, num("capexY0")))/100

  const revProduct = num("revProduct")
  const revCoprod  = num("revCoprod")

  const opFeed  = num("opFeed")
  const opUtil  = num("opUtil")
  const opLabor = num("opLabor")
  const opMaint = num("opMaint")

  const revenue0 = revProduct + revCoprod
  const opex0 = opFeed + opUtil + opLabor + opMaint
  const margin0 = revenue0 - opex0

  // Simple 2-year CAPEX schedule
  const capex0 = -capex * capexY0
  const capex1 = -capex * (1 - capexY0)

  let npv = 0
  const cash = []
  for(let y=0;y<=life;y++){
    let cf = 0
    if(y === 0) cf += capex0
    if(y === 1) cf += capex1

    if(y >= 1){
      const esc = Math.pow(1+inflation, y-1)
      const margin = margin0 * esc
      cf += margin
    }

    cash.push(cf)
    npv += cf / Math.pow(1+r, y)
  }

  appState.tea = {
    npv,
    cash,
    life,
    r,
    inflation,
    revenue0,
    opex0,
    margin0
  }

  const kpiEl = document.getElementById("teaKPI")
  kpiEl.textContent = ""
  const npvLine = document.createElement("div")
  npvLine.textContent = `NPV: ${money(npv)}`
  kpiEl.appendChild(npvLine)

  const pills = document.createElement("div")
  pills.className = "kpi"
  pills.innerHTML =
    `<span class="pill">Revenue (Y1): ${money(revenue0)}</span>` +
    `<span class="pill">OPEX (Y1): ${money(opex0)}</span>` +
    `<span class="pill">Margin (Y1): ${money(margin0)}</span>`
  kpiEl.appendChild(pills)

  drawTEAChart(cash)

  toast("TEA updated")
  updateSummary()
}

function drawTEAChart(cash){
  if(teaChart) teaChart.destroy()
  const ctx = document.getElementById("teaChart").getContext("2d")
  teaChart = new Chart(ctx,{
    type:'line',
    data:{
      labels: cash.map((_,i)=>`Y${i}`),
      datasets:[{
        label:'Annual net cashflow',
        data: cash,
        tension:0.25
      }]
    },
    options:{
      plugins:{ legend:{ position:'bottom' } },
      scales:{ y:{ ticks:{ callback:(v)=> money(v).replace("$","") } } },
      onClick:(evt, elements)=>{
        const out = document.getElementById("teaClickInfo")
        if(!elements || !elements.length){ out.textContent=""; return }
        const i = elements[0].index
        out.textContent = `${cash[i] < 0 ? "Outflow" : "Inflow"} at Y${i}: ${money(cash[i])}`
      }
    }
  })
}

/* ---------------- SENSITIVITY ---------------- */
function runSensitivity(){
  // Require baseline runs for coherent results
  if(!appState.lca) runLCA()
  if(!appState.tea) runTEA()

  const param = document.getElementById("sensParam").value
  const rangePct = Math.max(0, num("sensRange"))/100
  const steps = Math.max(3, intNum("sensSteps"))

  const el = document.getElementById(param)
  if(!el){
    toast("Parameter not found in UI")
    return
  }

  const base = num(param)
  const xs = []
  const ysGHG = []
  const ysNPV = []

  // Save current UI values to restore
  const saved = {}
  const idsToSave = ["gridEF","truckEF","km","efGas","discount","revProduct","opFeed"]
  idsToSave.forEach(id=> saved[id] = document.getElementById(id).value)

  for(let i=0;i<steps;i++){
    const f = -rangePct + (2*rangePct)*(i/(steps-1))
    const v = base * (1 + f)
    el.value = String(v)

    // Recompute
    runLCA()
    runTEA()

    xs.push(v)
    ysGHG.push(appState.lca.net_kg)
    ysNPV.push(appState.tea.npv)
  }

  // Restore
  idsToSave.forEach(id=> document.getElementById(id).value = saved[id])
  runLCA()
  runTEA()

  document.getElementById("sensNote").textContent =
    `Sweep: ${param} from ${(base*(1-rangePct)).toFixed(4)} to ${(base*(1+rangePct)).toFixed(4)} (${steps} points).`

  drawSensitivityChart(xs, ysGHG, ysNPV, param)
  toast("Sensitivity updated")
  updateSummary()
}

function drawSensitivityChart(xs, ghg, npv, param){
  if(sensChart) sensChart.destroy()
  const ctx = document.getElementById("sensChart").getContext("2d")
  sensChart = new Chart(ctx,{
    type:'line',
    data:{
      labels: xs.map(v=>String(v)),
      datasets:[
        { label:'Net GHG (kg CO₂e/FU)', data: ghg, yAxisID:'y1', tension:0.25 },
        { label:'NPV ($)', data: npv, yAxisID:'y2', tension:0.25 }
      ]
    },
    options:{
      plugins:{ legend:{ position:'bottom' } },
      scales:{
        y1:{ type:'linear', position:'left', beginAtZero:false, title:{ display:true, text:'kg CO₂e/FU' } },
        y2:{ type:'linear', position:'right', beginAtZero:false, grid:{ drawOnChartArea:false }, title:{ display:true, text:'$' },
          ticks:{ callback:(v)=> (v/1e6).toFixed(1) + "M" }
        }
      },
      onClick:(evt, elements)=>{
        const out = document.getElementById("sensClickInfo")
        if(!elements || !elements.length){ out.textContent=""; return }
        const i = elements[0].index
        out.textContent = `${param}=${xs[i]} → Net GHG=${ghg[i].toFixed(2)} kg CO₂e/FU, NPV=${money(npv[i])}`
      }
    }
  })
}

/* ---------------- SUMMARY ---------------- */
function updateSummary(){
  const hasLCA = !!appState.lca
  const hasTEA = !!appState.tea

  const scope = document.getElementById("scopeLine")
  const fuLabel = document.getElementById("fuLabel").value || "1 FU"
  const boundary = document.getElementById("boundary").value
  const copro = document.getElementById("coproductMethod").value
  scope.textContent = `FU: ${fuLabel} • Boundary: ${boundary.replaceAll("_","-")} • Co-product: ${copro.replaceAll("_","-")}`

  const r = document.getElementById("summaryResults")
  const e = document.getElementById("summaryExtras")

  if(hasLCA && hasTEA){
    r.innerHTML =
      `Net GHG: ${appState.lca.net_kg.toFixed(1)} kg CO₂e/FU` +
      ` <span class='pill'>Gross: ${appState.lca.gross_kg.toFixed(1)}</span>` +
      ` <span class='pill'>NPV: ${money(appState.tea.npv)}</span>`

    const f = appState.lca.flows
    e.textContent =
      `Inventory — In: feed ${f.feedIn} ${massUnitLabel()}, water ${f.waterIn} ${massUnitLabel()}, air ${f.airIn} ${massUnitLabel()}. ` +
      `Out: product ${f.prodOut} ${massUnitLabel()}, co-prod ${f.coprodOut} ${massUnitLabel()}, wastes (S/L/G) ${f.wSolid}/${f.wLiquid}/${f.wGas} ${massUnitLabel()}, ` +
      `evap ${f.waterVaporOut} ${massUnitLabel()}, CO₂ ${f.co2Out} ${massUnitLabel()}. ` +
      `Energy in (elec/heat): ${f.elecIn} kWh, ${f.heatIn} MJ. Energy out (elec/heat): ${f.elecOut} kWh, ${f.heatOut} MJ.`
  } else {
    r.textContent = "Run LCA and TEA first."
    e.textContent = ""
  }
}

/* Keyboard shortcut: Ctrl/⌘ + Enter runs the relevant model for active tab */
document.addEventListener("keydown", (ev)=>{
  if((ev.ctrlKey || ev.metaKey) && ev.key === "Enter"){
    if(document.getElementById("lca").classList.contains("active")) runLCA()
    else if(document.getElementById("tea").classList.contains("active")) runTEA()
    else if(document.getElementById("sensitivity").classList.contains("active")) runSensitivity()
    else toast("Go to LCA / TEA / Sensitivity to run models")
  }
})

/* Initialize */
setActiveTab("scope")
requestAnimationFrame(()=>document.getElementById("scope").classList.add("visible"))
</script>
</body>
</html>
