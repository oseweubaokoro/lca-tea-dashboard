<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OVO — LCA + TEA Interactive Dashboard</title>

  <!-- Hardening (inline CSS/JS => 'unsafe-inline' unless you externalize files) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' https://cdn.jsdelivr.net;
          script-src  'self' https://cdn.jsdelivr.net 'unsafe-inline';
          style-src   'self' 'unsafe-inline';
          img-src     'self' data:;
          connect-src 'self';
          base-uri    'self';
          form-action 'self';
        " />

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg1:#1e3c72;
      --bg2:#2a5298;
      --glass: rgba(255,255,255,0.10);
      --glass2: rgba(255,255,255,0.16);
      --text: rgba(255,255,255,0.95);
      --muted: rgba(255,255,255,0.78);
      --shadow: 0 12px 35px rgba(0,0,0,0.25);

      --ok: rgba(44, 196, 108, 0.22);
      --warn: rgba(255, 193, 7, 0.22);
      --bad: rgba(255, 107, 107, 0.22);
      --ring: rgba(255,255,255,0.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(255,255,255,0.10), transparent 55%),
        radial-gradient(1200px 800px at 80% 70%, rgba(255,255,255,0.10), transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }

    header{
      padding:18px 18px 10px;
      text-align:center;
      font-size:24px;
      font-weight:800;
      letter-spacing:0.3px;
      background:rgba(0,0,0,0.20);
      border-bottom:1px solid rgba(255,255,255,0.10);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    header h1{
      margin:0;
      font-size:24px;
      font-weight:900;
    }
    header .sub{
      margin-top:6px;
      font-size:12px;
      font-weight:800;
      color: rgba(255,255,255,0.85);
      letter-spacing:0.2px;
    }

    nav{
      display:flex;
      justify-content:center;
      gap:12px;
      padding:14px 14px 6px;
      flex-wrap:wrap;
    }

    nav button{
      background: rgba(255,255,255,0.92);
      color:#1e3c72;
      border:none;
      padding:10px 18px;
      border-radius:999px;
      cursor:pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,0.18);
      font-weight:800;
      outline: none;
    }
    nav button:hover{ transform: translateY(-1px) scale(1.03); }
    nav button:active{ transform: translateY(1px) scale(0.98); opacity:0.9; }
    nav button.active{
      background: rgba(255,255,255,1);
      box-shadow: 0 14px 25px rgba(0,0,0,0.28);
    }
    nav button:focus-visible{
      box-shadow: 0 0 0 3px var(--ring), 0 14px 25px rgba(0,0,0,0.28);
    }

    .container{
      max-width:1100px;
      margin: 0 auto;
      padding: 10px 16px 28px;
    }

    .page{
      display:none;
      opacity:0;
      transform: translateY(10px);
      transition: opacity 220ms ease, transform 220ms ease;
      will-change: opacity, transform;
    }
    .page.active{ display:block; }
    .page.visible{
      opacity:1;
      transform: translateY(0);
    }

    .card{
      background:var(--glass);
      backdrop-filter: blur(12px);
      border-radius:18px;
      padding:18px;
      margin:14px 0;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.12);
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease;
      animation: cardIn 340ms ease both;
    }
    .card:hover{
      transform: translateY(-3px);
      background: var(--glass2);
      border-color: rgba(255,255,255,0.18);
    }
    @keyframes cardIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    h2,h3{ margin: 0 0 12px; }
    h2{ font-size:18px; }
    h3{ font-size:16px; }

    .small{ font-size:12px; color:var(--muted); line-height:1.35; }
    .kpi{
      font-size:22px;
      font-weight:900;
      margin-top:10px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.92);
    }
    .pill.ok{ background: var(--ok); }
    .pill.warn{ background: var(--warn); }
    .pill.bad{ background: var(--bad); }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap:12px;
    }

    label{
      font-size:13px;
      color: rgba(255,255,255,0.92);
      display:block;
      margin-bottom:6px;
      font-weight:900;
    }

    .field{
      background: rgba(0,0,0,0.16);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:12px;
      transition: transform 140ms ease, border-color 140ms ease, background 140ms ease;
    }
    .field:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.20);
      background: rgba(0,0,0,0.18);
    }
    .field.invalid{
      border-color: rgba(255,107,107,0.55);
      box-shadow: 0 0 0 2px rgba(255,107,107,0.15);
    }

    .inputRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    select{
      appearance:none;
    }
    input:focus-visible, select:focus-visible{
      border-color: rgba(255,255,255,0.55);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.14);
    }
    .unit{
      min-width:72px;
      text-align:right;
      font-size:12px;
      font-weight:900;
      color: rgba(255,255,255,0.88);
      opacity:0.9;
      user-select:none;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .actions button{
      background: rgba(255,255,255,0.95);
      color:#1e3c72;
      border:none;
      padding:10px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      transition: transform 140ms ease, box-shadow 140ms ease, opacity 140ms ease;
      box-shadow: 0 10px 20px rgba(0,0,0,0.20);
      outline:none;
    }
    .actions button:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 25px rgba(0,0,0,0.26);
    }
    .actions button:active{ transform: translateY(1px); opacity:0.9; }
    .actions button:focus-visible{
      box-shadow: 0 0 0 3px var(--ring), 0 14px 25px rgba(0,0,0,0.26);
    }

    hr.sep{
      border:none;
      height:1px;
      background:rgba(255,255,255,0.18);
      margin:18px 0;
    }

    .chartWrap{
      background:white;
      border-radius:16px;
      padding:10px;
      margin-top:10px;
    }
    canvas{ width:100% !important; height:320px !important; }

    .toast{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(0,0,0,0.70);
      border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.95);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity 220ms ease, transform 220ms ease;
      backdrop-filter: blur(10px);
      z-index:999;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    details{
      background: rgba(0,0,0,0.14);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:12px;
    }
    details summary{
      cursor:pointer;
      font-weight:900;
    }
    details .small{ margin-top:8px; }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top:10px;
      overflow:hidden;
      border-radius: 12px;
    }
    .table th, .table td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      text-align:left;
    }
    .table th{
      color: rgba(255,255,255,0.95);
      font-weight:900;
    }
    .table td{
      color: rgba(255,255,255,0.85);
      font-weight:800;
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
    }
  </style>
</head>

<body>
  <header>
    <h1>OVO — Integrated LCA + TEA Dashboard</h1>
    <div class="sub">Screening model + one-way sensitivity (tornado)</div>
  </header>

  <nav role="tablist" aria-label="Dashboard sections">
    <button id="tab-lca" role="tab" aria-controls="lca" aria-selected="true" onclick="showPage('lca')">LCA</button>
    <button id="tab-tea" role="tab" aria-controls="tea" aria-selected="false" onclick="showPage('tea')">TEA</button>
    <button id="tab-summary" role="tab" aria-controls="summary" aria-selected="false" onclick="showPage('summary')">Summary</button>
  </nav>

  <div class="container">

    <!-- LCA -->
    <section id="lca" class="page active" role="tabpanel" aria-labelledby="tab-lca">
      <div class="card">
        <h2>LCA System Inventory (per FU)</h2>

        <div class="grid">
          <div class="field" data-field>
            <label for="feedIn">Feedstock in</label>
            <div class="inputRow">
              <input id="feedIn" type="number" min="0" step="0.001" inputmode="decimal" value="3">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Mass of biomass/feedstock entering the process.</div>
          </div>

          <div class="field" data-field>
            <label for="prodOut">Main product out</label>
            <div class="inputRow">
              <input id="prodOut" type="number" min="0" step="0.001" inputmode="decimal" value="1">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Mass of main product leaving the gate.</div>
          </div>

          <div class="field" data-field>
            <label for="coprodOut">Co-product out</label>
            <div class="inputRow">
              <input id="coprodOut" type="number" min="0" step="0.001" inputmode="decimal" value="0">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Optional secondary product; set to 0 if none.</div>
          </div>

          <div class="field" data-field>
            <label for="wSolid">Solid waste out</label>
            <div class="inputRow">
              <input id="wSolid" type="number" min="0" step="0.001" inputmode="decimal" value="0.2">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">E.g., ash, char, sludge cake.</div>
          </div>

          <div class="field" data-field>
            <label for="wLiquid">Liquid waste out</label>
            <div class="inputRow">
              <input id="wLiquid" type="number" min="0" step="0.001" inputmode="decimal" value="0.1">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">TOTAL liquid waste mass (e.g., wastewater, purge).</div>
          </div>

          <div class="field" data-field>
            <label for="wGas">Gaseous waste out</label>
            <div class="inputRow">
              <input id="wGas" type="number" min="0" step="0.001" inputmode="decimal" value="0.05">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">TOTAL gas waste mass vented/treated (not product gas).</div>
          </div>

          <div class="field" data-field>
            <label for="waterIn">Added water / moisture in</label>
            <div class="inputRow">
              <input id="waterIn" type="number" min="0" step="0.001" inputmode="decimal" value="0">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Make-up water, moisture, solvents counted as water-equivalent.</div>
          </div>

          <div class="field" data-field>
            <label for="airIn">Air in (optional)</label>
            <div class="inputRow">
              <input id="airIn" type="number" min="0" step="0.001" inputmode="decimal" value="0">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Only use if you explicitly want air mass tracked (often excluded in gate balances).</div>
          </div>

          <div class="field" data-field>
            <label for="waterVaporOut">Evaporated water out</label>
            <div class="inputRow">
              <input id="waterVaporOut" type="number" min="0" step="0.001" inputmode="decimal" value="0">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Water leaving as vapor (drying, vents, evaporation).</div>
          </div>

          <div class="field" data-field>
            <label for="co2Out">CO₂ to air out</label>
            <div class="inputRow">
              <input id="co2Out" type="number" min="0" step="0.001" inputmode="decimal" value="0">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">For mass balance only. Does NOT imply fossil GHG without carbon accounting.</div>
          </div>

          <div class="field" data-field>
            <label for="otherIn">Other inputs (optional)</label>
            <div class="inputRow">
              <input id="otherIn" type="number" min="0" step="0.001" inputmode="decimal" value="0">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Chemicals, catalysts, solvents (mass basis), etc. screening term.</div>
          </div>

          <div class="field" data-field>
            <label for="otherOut">Other outputs (optional)</label>
            <div class="inputRow">
              <input id="otherOut" type="number" min="0" step="0.001" inputmode="decimal" value="0">
              <div class="unit">t/FU</div>
            </div>
            <div class="small">Untracked outputs not covered above screening term.</div>
          </div>
        </div>

        <hr class="sep">

        <h2>Energy + Logistics (per FU)</h2>
        <div class="grid">
          <div class="field" data-field>
            <label for="km">Transport distance</label>
            <div class="inputRow">
              <input id="km" type="number" min="0" step="1" inputmode="numeric" value="120">
              <div class="unit">km</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="truckEF">Truck EF</label>
            <div class="inputRow">
              <input id="truckEF" type="number" min="0" step="0.001" inputmode="decimal" value="0.12">
              <div class="unit">kg/(t·km)</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="elecIn">Electricity in</label>
            <div class="inputRow">
              <input id="elecIn" type="number" min="0" step="1" inputmode="numeric" value="900">
              <div class="unit">kWh/FU</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="gridEF">Grid EF</label>
            <div class="inputRow">
              <input id="gridEF" type="number" min="0" step="0.001" inputmode="decimal" value="0.35">
              <div class="unit">kg/kWh</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="heatIn">Heat/Steam in</label>
            <div class="inputRow">
              <input id="heatIn" type="number" min="0" step="1" inputmode="numeric" value="0">
              <div class="unit">MJ/FU</div>
            </div>
            <div class="small">Set 0 if not used.</div>
          </div>

          <div class="field" data-field>
            <label for="heatEF">Heat EF</label>
            <div class="inputRow">
              <input id="heatEF" type="number" min="0" step="0.001" inputmode="decimal" value="0.07">
              <div class="unit">kg/MJ</div>
            </div>
            <div class="small">Replace with your factor (fuel/steam source).</div>
          </div>

          <div class="field" data-field>
            <label for="elecOut">Exported electricity</label>
            <div class="inputRow">
              <input id="elecOut" type="number" min="0" step="1" inputmode="numeric" value="0">
              <div class="unit">kWh/FU</div>
            </div>
            <div class="small">Credit uses Grid EF.</div>
          </div>

          <div class="field" data-field>
            <label for="heatOut">Exported heat</label>
            <div class="inputRow">
              <input id="heatOut" type="number" min="0" step="1" inputmode="numeric" value="0">
              <div class="unit">MJ/FU</div>
            </div>
            <div class="small">Credit uses Heat EF.</div>
          </div>
        </div>

        <hr class="sep">

        <h2>Waste Treatment Emission Factors</h2>
        <div class="grid">
          <div class="field" data-field>
            <label for="efSolid">Solid waste EF</label>
            <div class="inputRow">
              <input id="efSolid" type="number" min="0" step="1" inputmode="numeric" value="50">
              <div class="unit">kg/t</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="efLiquid">Liquid waste EF</label>
            <div class="inputRow">
              <input id="efLiquid" type="number" min="0" step="1" inputmode="numeric" value="30">
              <div class="unit">kg/t</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="efGas">Gas waste EF</label>
            <div class="inputRow">
              <input id="efGas" type="number" min="0" step="1" inputmode="numeric" value="200">
              <div class="unit">kg/t</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <select id="scenario" aria-label="Scenario presets">
            <option value="">Scenario presets…</option>
            <option value="low">Low-impact (lower grid EF, shorter haul, lower gas waste EF)</option>
            <option value="high">High-impact (higher grid EF, longer haul, higher gas waste EF)</option>
            <option value="reset">Reset to defaults</option>
          </select>

          <button onclick="runLCA()">Run LCA</button>
          <button onclick="copyResults()">Copy results (JSON)</button>
        </div>

        <div id="lcaKPI" class="kpi" aria-live="polite"></div>
        <div id="lcaStatus" class="small"></div>
        <div id="lcaErrors" class="small" style="margin-top:8px;"></div>

        <details style="margin-top:12px;">
          <summary>Interaction + caveats</summary>
          <div class="small">
            • Screening-level. Document factors and credit assumptions. Do sensitivity/uncertainty checks.<br>
            • Ctrl/⌘+Enter runs the model on the active tab.<br>
            • Emissions breakdown shows credits as negative contributions.<br>
            • Energy chart uses kWh-equivalent for heat (1 kWh = 3.6 MJ) for visualization only.
          </div>
        </details>
      </div>

      <div class="card">
        <h2>Emissions breakdown (kg CO₂e/FU)</h2>
        <div class="chartWrap">
          <canvas id="lcaChart" aria-label="Emissions breakdown chart" role="img"></canvas>
        </div>

        <details style="margin-top:12px;">
          <summary>Emissions breakdown table (accessible)</summary>
          <table class="table" id="lcaTable" aria-label="Emissions breakdown table">
            <thead>
              <tr><th>Category</th><th>kg CO₂e/FU</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </details>
      </div>

      <div class="card">
        <h2>Mass balance (t/FU)</h2>
        <div class="small">Only tonne-based flows. Quick check, not a full elemental balance.</div>
        <div class="chartWrap">
          <canvas id="massChart" aria-label="Mass balance chart" role="img"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>Energy (kWh-eq/FU)</h2>
        <div class="small">Heat converted to kWh-equivalent using 1 kWh = 3.6 MJ for plotting.</div>
        <div class="chartWrap">
          <canvas id="energyChart" aria-label="Energy chart" role="img"></canvas>
        </div>
      </div>
    </section>

    <!-- TEA -->
    <section id="tea" class="page" role="tabpanel" aria-labelledby="tab-tea">
      <div class="card">
        <h2>TEA Inputs</h2>
        <div class="grid">
          <div class="field" data-field>
            <label for="life">Project life</label>
            <div class="inputRow">
              <input id="life" type="number" min="1" step="1" inputmode="numeric" value="15">
              <div class="unit">years</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="discount">Discount rate</label>
            <div class="inputRow">
              <input id="discount" type="number" min="0" step="0.1" inputmode="decimal" value="8">
              <div class="unit">%/yr</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="capex">CAPEX</label>
            <div class="inputRow">
              <input id="capex" type="number" min="0" step="1000" inputmode="numeric" value="5000000">
              <div class="unit">$</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="revenue">Revenue (annual)</label>
            <div class="inputRow">
              <input id="revenue" type="number" min="0" step="1000" inputmode="numeric" value="2000000">
              <div class="unit">$/yr</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="opex">OPEX (annual)</label>
            <div class="inputRow">
              <input id="opex" type="number" min="0" step="1000" inputmode="numeric" value="1200000">
              <div class="unit">$/yr</div>
            </div>
          </div>

          <div class="field" data-field>
            <label for="salvage">Salvage value (end)</label>
            <div class="inputRow">
              <input id="salvage" type="number" min="0" step="1000" inputmode="numeric" value="0">
              <div class="unit">$</div>
            </div>
            <div class="small">Optional terminal value at end of life (screening).</div>
          </div>

          <div class="field" data-field>
            <label for="wc">Working capital (initial)</label>
            <div class="inputRow">
              <input id="wc" type="number" min="0" step="1000" inputmode="numeric" value="0">
              <div class="unit">$</div>
            </div>
            <div class="small">Tied up at year 0 and released at end of life (screening).</div>
          </div>
        </div>

        <div class="actions">
          <button onclick="runTEA()">Run TEA</button>
          <button onclick="copyResults()">Copy results (JSON)</button>
        </div>

        <div id="teaKPI" class="kpi" aria-live="polite"></div>
        <div id="teaErrors" class="small" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <h2>Cashflow</h2>
        <div class="chartWrap">
          <canvas id="teaChart" aria-label="Cashflow chart" role="img"></canvas>
        </div>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="summary" class="page" role="tabpanel" aria-labelledby="tab-summary">
      <div class="card">
        <h2>Integrated Results</h2>
        <div id="summaryResults" class="kpi" aria-live="polite"></div>
        <div id="summaryExtras" class="small"></div>
      </div>

      <div class="card">
        <h2>Sensitivity analysis (one-way tornado)</h2>
        <div class="small">
          Varies one parameter at a time around the current inputs. Default uses ±% perturbation.
          Run LCA/TEA first for the chosen metric.
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="field">
            <label for="sensMetric">Metric</label>
            <select id="sensMetric">
              <option value="lca_net">LCA: Net GHG (kg CO₂e/FU)</option>
              <option value="tea_npv">TEA: NPV ($)</option>
            </select>
            <div class="small">Choose what the tornado chart shows.</div>
          </div>

          <div class="field">
            <label for="sensPct">Variation (±%)</label>
            <input id="sensPct" type="number" min="0" step="1" inputmode="numeric" value="20" />
            <div class="small">Example: 20 = ±20% around baseline.</div>
          </div>

          <div class="field">
            <label for="sensTopN">Show top N</label>
            <input id="sensTopN" type="number" min="1" step="1" inputmode="numeric" value="10" />
            <div class="small">Sorted by absolute impact.</div>
          </div>
        </div>

        <div class="actions">
          <button onclick="runSensitivity()">Run sensitivity</button>
          <button onclick="useRecommendedSensParams()">Show parameter list</button>
          <button onclick="copySensitivity()">Copy sensitivity (JSON)</button>
        </div>

        <div id="sensKPI" class="kpi" aria-live="polite"></div>

        <div class="chartWrap">
          <canvas id="sensChart" aria-label="Sensitivity tornado chart" role="img"></canvas>
        </div>

        <details style="margin-top:12px;">
          <summary>Parameters included</summary>
          <div class="small" id="sensParamList"></div>
        </details>
      </div>

      <div class="card">
        <h2>Quick notes</h2>
        <div class="small">
          Screening tool only. Biggest uncertainties often: waste treatment EFs, energy EFs, and displacement/credit assumptions.
          For decisions, use documented sources and formal uncertainty (e.g., distributions + Monte Carlo).
        </div>
      </div>
    </section>

  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------------- State + defaults ----------------
    const DEFAULTS = {
      // LCA mass (t/FU)
      feedIn: 3,
      prodOut: 1,
      coprodOut: 0,
      wSolid: 0.2,
      wLiquid: 0.1,
      wGas: 0.05,
      waterIn: 0,
      airIn: 0,
      waterVaporOut: 0,
      co2Out: 0,
      otherIn: 0,
      otherOut: 0,

      // Logistics + energy
      km: 120,
      truckEF: 0.12,
      elecIn: 900,
      gridEF: 0.35,
      heatIn: 0,
      heatEF: 0.07,
      elecOut: 0,
      heatOut: 0,

      // Waste EFs (kg CO2e / t)
      efSolid: 50,
      efLiquid: 30,
      efGas: 200,

      // TEA
      life: 15,
      discount: 8,
      capex: 5000000,
      revenue: 2000000,
      opex: 1200000,
      salvage: 0,
      wc: 0
    };

    const INPUT_IDS = Object.keys(DEFAULTS);
    const STORAGE_KEY = "ovo_lca_tea_dashboard_v3";

    let appState = {
      lca: null,
      tea: null,
      dirtyLCA: true,
      dirtyTEA: true,
      sensitivity: null
    };

    let lcaChart = null;
    let teaChart = null;
    let massChart = null;
    let energyChart = null;
    let sensChart = null;

    const fmt1 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 1 });
    const fmt2 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
    const fmt0 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
    const fmt3 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 3 });

    function $(id){ return document.getElementById(id); }

    function readNum(id){
      const el = $(id);
      const v = el.value;
      const x = Number(v);
      return Number.isFinite(x) ? x : NaN;
    }

    function setActiveTab(id){
      document.querySelectorAll("nav button").forEach(b=>{
        b.classList.remove("active");
        b.setAttribute("aria-selected","false");
      });
      const tab = $("tab-"+id);
      if(tab){
        tab.classList.add("active");
        tab.setAttribute("aria-selected","true");
      }
    }

    function showPage(id){
      setActiveTab(id);

      document.querySelectorAll('.page').forEach(p=>{
        p.classList.remove('active','visible');
      });
      const page = $(id);
      page.classList.add('active');
      requestAnimationFrame(()=>page.classList.add('visible'));

      updateSummary();
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=>t.classList.remove("show"), 1800);
    }

    function animateKPI(el, newText, durationMs=650){
      const prev = el.textContent || "";
      const mNew = newText.match(/(-?\d+(\.\d+)?)/);
      const mOld = prev.match(/(-?\d+(\.\d+)?)/);
      if(!mNew){
        el.textContent = newText;
        return;
      }
      const target = parseFloat(mNew[1]);
      const start = mOld ? parseFloat(mOld[1]) : 0;

      const prefix = newText.slice(0, mNew.index);
      const suffix = newText.slice(mNew.index + mNew[1].length);

      const t0 = performance.now();
      function step(t){
        const u = Math.min(1, (t - t0)/durationMs);
        const eased = 1 - Math.pow(1-u, 3);
        const val = start + (target - start)*eased;

        let body;
        if (suffix.includes("$")) body = fmt0.format(Math.round(val));
        else if (suffix.includes("kg") || suffix.includes("%")) body = fmt1.format(val);
        else body = fmt2.format(val);

        el.textContent = prefix + body + suffix;
        if(u < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ---------------- Persistence ----------------
    function loadSaved(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        if(!data || typeof data !== "object") return;
        for(const id of INPUT_IDS){
          if(data[id] !== undefined && $(id)) $(id).value = String(data[id]);
        }
      }catch(_){}
    }

    function saveNow(){
      const out = {};
      for(const id of INPUT_IDS){
        if($(id)) out[id] = $(id).value;
      }
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(out)); }catch(_){}
    }

    function resetDefaults(){
      for(const id of INPUT_IDS){
        if($(id)) $(id).value = String(DEFAULTS[id]);
      }
      try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
      markDirty("lca");
      markDirty("tea");
      appState.lca = null;
      appState.tea = null;
      appState.sensitivity = null;
      updateAllStatus();
      destroyCharts();
      updateSummary();
      toast("Reset to defaults");
    }

    // ---------------- Validation ----------------
    function clearFieldValidity(){
      document.querySelectorAll("[data-field]").forEach(f=>f.classList.remove("invalid"));
      $("lcaErrors").textContent = "";
      $("teaErrors").textContent = "";
    }

    function invalidate(id){
      const el = $(id);
      if(!el) return;
      const field = el.closest("[data-field]");
      if(field) field.classList.add("invalid");
    }

    function validateLCA(){
      const errs = [];
      const nonneg = [
        "feedIn","prodOut","coprodOut","wSolid","wLiquid","wGas",
        "waterIn","airIn","waterVaporOut","co2Out","otherIn","otherOut",
        "km","truckEF","elecIn","gridEF","heatIn","heatEF","elecOut","heatOut",
        "efSolid","efLiquid","efGas"
      ];

      for(const id of nonneg){
        const x = readNum(id);
        if(!Number.isFinite(x)){
          errs.push(`${id}: not a number`);
          invalidate(id);
        } else if(x < 0){
          errs.push(`${id}: must be ≥ 0`);
          invalidate(id);
        }
      }
      return errs;
    }

    function validateTEA(){
      const errs = [];
      const life = readNum("life");
      const discount = readNum("discount");
      const capex = readNum("capex");
      const revenue = readNum("revenue");
      const opex = readNum("opex");
      const salvage = readNum("salvage");
      const wc = readNum("wc");

      const checks = [
        ["life", life, (x)=>Number.isFinite(x) && x >= 1],
        ["discount", discount, (x)=>Number.isFinite(x) && x >= 0],
        ["capex", capex, (x)=>Number.isFinite(x) && x >= 0],
        ["revenue", revenue, (x)=>Number.isFinite(x) && x >= 0],
        ["opex", opex, (x)=>Number.isFinite(x) && x >= 0],
        ["salvage", salvage, (x)=>Number.isFinite(x) && x >= 0],
        ["wc", wc, (x)=>Number.isFinite(x) && x >= 0],
      ];

      for(const [id, val, ok] of checks){
        if(!ok(val)){
          errs.push(`${id}: invalid (must be numeric and within bounds)`);
          invalidate(id);
        }
      }
      return errs;
    }

    // ---------------- Dirty state ----------------
    function markDirty(which){
      if(which === "lca") appState.dirtyLCA = true;
      if(which === "tea") appState.dirtyTEA = true;
      updateAllStatus();
    }

    function updateAllStatus(){
      const statusEl = $("lcaStatus");
      const pills = [];

      pills.push(appState.dirtyLCA
        ? `<span class="pill warn">Results out of date</span>`
        : `<span class="pill ok">Up to date</span>`);

      if(appState.lca && appState.lca.massCheck){
        const m = appState.lca.massCheck;
        const cls = m.absPct <= 2 ? "ok" : (m.absPct <= 5 ? "warn" : "bad");
        pills.push(`<span class="pill ${cls}">Mass Δ: ${fmt1.format(m.pct)}%</span>`);
      }

      statusEl.innerHTML = pills.join(" ");
    }

    function attachInputHandlers(){
      const debouncedSave = debounce(saveNow, 250);

      for(const id of INPUT_IDS){
        const el = $(id);
        if(!el) continue;

        el.addEventListener("input", ()=>{
          if(["life","discount","capex","revenue","opex","salvage","wc"].includes(id)) markDirty("tea");
          else markDirty("lca");
          clearFieldValidity();
          debouncedSave();
        });
      }

      $("scenario").addEventListener("change", (e)=>{
        const v = e.target.value;
        if(!v) return;
        if(v === "reset"){
          $("scenario").value = "";
          resetDefaults();
          return;
        }
        quickScenario(v);
        $("scenario").value = "";
      });

      $("sensMetric").addEventListener("change", ()=>useRecommendedSensParams());
    }

    function debounce(fn, ms){
      let t = null;
      return function(...args){
        clearTimeout(t);
        t = setTimeout(()=>fn.apply(this,args), ms);
      };
    }

    // ---------------- Charts helpers ----------------
    function destroyCharts(){
      for(const ch of [lcaChart, teaChart, massChart, energyChart, sensChart]){
        if(ch) ch.destroy();
      }
      lcaChart = teaChart = massChart = energyChart = sensChart = null;
    }

    function setTableBreakdown(rows){
      const tbody = $("lcaTable").querySelector("tbody");
      tbody.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        td1.textContent = r.label;
        td2.textContent = fmt2.format(r.value);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tbody.appendChild(tr);
      }
    }

    // ---------------- Pure compute functions (no DOM) ----------------
    function computeLCAFromInputs(I){
      const transport_kg = I.feedIn * I.km * I.truckEF;
      const elecIn_kg    = I.elecIn * I.gridEF;
      const heatIn_kg    = I.heatIn * I.heatEF;

      const wasteSolid_kg  = I.wSolid  * I.efSolid;
      const wasteLiquid_kg = I.wLiquid * I.efLiquid;
      const wasteGas_kg    = I.wGas    * I.efGas;

      const credits_kg = (I.elecOut * I.gridEF) + (I.heatOut * I.heatEF);

      const gross_kg = transport_kg + elecIn_kg + heatIn_kg + wasteSolid_kg + wasteLiquid_kg + wasteGas_kg;
      const net_kg = gross_kg - credits_kg;

      return { net_kg, gross_kg };
    }

    function computeTEAFromInputs(I){
      const life = Math.max(1, Math.round(I.life));
      const r = Math.max(0, I.discount) / 100;

      const capex = I.capex;
      const revenue = I.revenue;
      const opex = I.opex;
      const salvage = I.salvage || 0;
      const wc = I.wc || 0;

      const margin = revenue - opex;

      let npv = -(capex + wc);
      for(let y=1; y<=life; y++){
        const disc = (r === 0) ? 1 : Math.pow(1+r, y);
        npv += margin / disc;
      }
      const discT = (r === 0) ? 1 : Math.pow(1+r, life);
      npv += (salvage + wc) / discT;

      return { npv, margin };
    }

    function getAllInputs(){
      const out = {};
      for(const id of INPUT_IDS){
        if($(id)) out[id] = Number($(id).value);
      }
      return out;
    }

    // ---------------- LCA ----------------
    function runLCA(){
      clearFieldValidity();
      const errs = validateLCA();
      if(errs.length){
        $("lcaErrors").textContent = "Fix inputs: " + errs.slice(0,6).join(" • ") + (errs.length>6 ? " …" : "");
        toast("LCA: fix invalid inputs");
        return;
      }

      const I = getAllInputs();

      const { net_kg, gross_kg } = computeLCAFromInputs(I);

      const massIn  = I.feedIn + I.waterIn + I.airIn + I.otherIn;
      const massOut = I.prodOut + I.coprodOut + I.wSolid + I.wLiquid + I.wGas + I.waterVaporOut + I.co2Out + I.otherOut;
      const massDelta = massIn - massOut;
      const pct = massIn !== 0 ? (massDelta / massIn) * 100 : 0;

      appState.lca = {
        net_kg, gross_kg,
        breakdown: [
          { label: "Transport", value: I.feedIn * I.km * I.truckEF },
          { label: "Electricity in", value: I.elecIn * I.gridEF },
          { label: "Heat in", value: I.heatIn * I.heatEF },
          { label: "Solid waste", value: I.wSolid * I.efSolid },
          { label: "Liquid waste", value: I.wLiquid * I.efLiquid },
          { label: "Gas waste", value: I.wGas * I.efGas },
          { label: "Energy credits", value: -((I.elecOut * I.gridEF) + (I.heatOut * I.heatEF)) }
        ],
        flows: {
          feedIn: I.feedIn, waterIn: I.waterIn, airIn: I.airIn, otherIn: I.otherIn,
          prodOut: I.prodOut, coprodOut: I.coprodOut, wSolid: I.wSolid, wLiquid: I.wLiquid, wGas: I.wGas,
          waterVaporOut: I.waterVaporOut, co2Out: I.co2Out, otherOut: I.otherOut,
          elecIn: I.elecIn, heatIn: I.heatIn, elecOut: I.elecOut, heatOut: I.heatOut
        },
        massCheck: {
          massIn, massOut, massDelta, pct,
          absPct: Math.abs(pct)
        },
        meta: { mjPerKwh: 3.6 }
      };

      animateKPI($("lcaKPI"), "Net GHG: " + net_kg.toFixed(1) + " kg CO₂e/FU");

      const m = appState.lca.massCheck;
      const msg = `Mass check: in ${fmt3.format(m.massIn)} t/FU vs out ${fmt3.format(m.massOut)} t/FU (Δ=${fmt3.format(m.massDelta)} t, ${fmt1.format(m.pct)}%).`;
      $("lcaStatus").insertAdjacentHTML("beforeend", ` <span class="pill">${msg}</span>`);

      drawEmissionsChart(appState.lca.breakdown);
      drawMassChart(appState.lca.flows);
      drawEnergyChart(appState.lca.flows);
      setTableBreakdown(appState.lca.breakdown);

      appState.dirtyLCA = false;
      updateAllStatus();
      toast("LCA updated");
      updateSummary();
    }

    function drawEmissionsChart(rows){
      if(lcaChart) lcaChart.destroy();
      const labels = rows.map(r=>r.label);
      const data = rows.map(r=>r.value);

      const ctx = $("lcaChart").getContext("2d");
      lcaChart = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'kg CO₂e/FU', data }] },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:(c)=> `${c.label}: ${fmt2.format(c.parsed.y)} kg CO₂e` } }
          },
          scales:{
            y:{ beginAtZero:false, title:{ display:true, text:'kg CO₂e/FU' } }
          }
        }
      });
    }

    function drawMassChart(f){
      if(massChart) massChart.destroy();
      const labels = ["Feed","Water","Air","Other in","Product","Co-product","Solid waste","Liquid waste","Gas waste","Evap water","CO₂","Other out"];
      const massIn  = [f.feedIn,f.waterIn,f.airIn,f.otherIn,0,0,0,0,0,0,0,0];
      const massOut = [0,0,0,0,f.prodOut,f.coprodOut,f.wSolid,f.wLiquid,f.wGas,f.waterVaporOut,f.co2Out,f.otherOut];

      const ctx = $("massChart").getContext("2d");
      massChart = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:"In (t/FU)", data: massIn },
            { label:"Out (t/FU)", data: massOut }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom' } },
          scales:{ y:{ beginAtZero:true, title:{ display:true, text:"t/FU" } } }
        }
      });
    }

    function drawEnergyChart(f){
      if(energyChart) energyChart.destroy();
      const MJ_PER_KWH = 3.6;

      const labels = ["Electricity", "Heat (kWh-eq)"];
      const inData = [f.elecIn, f.heatIn / MJ_PER_KWH];
      const outData = [f.elecOut, f.heatOut / MJ_PER_KWH];

      const ctx = $("energyChart").getContext("2d");
      energyChart = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:"In (kWh-eq/FU)", data: inData },
            { label:"Out (kWh-eq/FU)", data: outData }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom' } },
          scales:{ y:{ beginAtZero:true, title:{ display:true, text:"kWh-eq/FU" } } }
        }
      });
    }

    function quickScenario(which){
      if(which === 'low'){
        $("gridEF").value = "0.15";
        $("km").value = "50";
        $("efGas").value = "100";
        toast("Loaded low-impact assumptions");
      }else if(which === 'high'){
        $("gridEF").value = "0.55";
        $("km").value = "250";
        $("efGas").value = "400";
        toast("Loaded high-impact assumptions");
      }
      saveNow();
      markDirty("lca");
      runLCA();
    }

    // ---------------- TEA ----------------
    function runTEA(){
      clearFieldValidity();
      const errs = validateTEA();
      if(errs.length){
        $("teaErrors").textContent = "Fix inputs: " + errs.slice(0,6).join(" • ") + (errs.length>6 ? " …" : "");
        toast("TEA: fix invalid inputs");
        return;
      }

      const I = getAllInputs();
      const { npv } = computeTEAFromInputs(I);

      appState.tea = { npv };

      animateKPI($("teaKPI"), "NPV: $" + npv.toFixed(0));

      const life = Math.max(1, Math.round(I.life));
      const r = Math.max(0, I.discount)/100;
      const capex = I.capex;
      const revenue = I.revenue;
      const opex = I.opex;
      const salvage = I.salvage || 0;
      const wc = I.wc || 0;
      const margin = revenue - opex;

      const cash = [-(capex + wc)];
      for(let y=1;y<=life;y++) cash.push(margin);
      cash[cash.length - 1] += (salvage + wc);

      if(teaChart) teaChart.destroy();
      teaChart = new Chart($("teaChart").getContext("2d"),{
        type:'line',
        data:{
          labels: cash.map((_,i)=>i),
          datasets:[{ label:'Annual cashflow ($)', data: cash, tension:0.25 }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:(c)=> `Year ${c.label}: $${fmt0.format(c.parsed.y)}` } }
          },
          scales:{ y:{ title:{ display:true, text:"$" } }, x:{ title:{ display:true, text:"Year" } } }
        }
      });

      appState.dirtyTEA = false;
      updateAllStatus();
      toast("TEA updated");
      updateSummary();
    }

    // ---------------- SUMMARY ----------------
    function updateSummary(){
      const hasLCA = !!appState.lca && Number.isFinite(appState.lca.net_kg);
      const hasTEA = !!appState.tea && Number.isFinite(appState.tea.npv);

      const r = $("summaryResults");
      const e = $("summaryExtras");

      if(hasLCA && hasTEA){
        const m = appState.lca.massCheck;
        r.innerHTML =
          `Net GHG: ${fmt1.format(appState.lca.net_kg)} kg CO₂e/FU ` +
          `<span class="pill">Gross: ${fmt1.format(appState.lca.gross_kg)}</span>` +
          `<span class="pill">NPV: $${fmt0.format(appState.tea.npv)}</span>` +
          `<span class="pill">Mass Δ: ${fmt1.format(m.pct)}%</span>`;

        const f = appState.lca.flows;
        e.textContent =
          `Inventory — In (t/FU): feed ${fmt3.format(f.feedIn)}, water ${fmt3.format(f.waterIn)}, air ${fmt3.format(f.airIn)}, other ${fmt3.format(f.otherIn)}. ` +
          `Out (t/FU): product ${fmt3.format(f.prodOut)}, co-prod ${fmt3.format(f.coprodOut)}, wastes S/L/G ${fmt3.format(f.wSolid)}/${fmt3.format(f.wLiquid)}/${fmt3.format(f.wGas)}, ` +
          `evap ${fmt3.format(f.waterVaporOut)}, CO₂ ${fmt3.format(f.co2Out)}, other ${fmt3.format(f.otherOut)}. ` +
          `Energy — in: ${fmt0.format(f.elecIn)} kWh, ${fmt0.format(f.heatIn)} MJ. out: ${fmt0.format(f.elecOut)} kWh, ${fmt0.format(f.heatOut)} MJ.`;
      } else {
        r.textContent = "Run LCA and TEA first.";
        e.textContent = "";
      }
    }

    // ---------------- Export ----------------
    function copyResults(){
      const payload = {
        owner: "OVO",
        timestamp: new Date().toISOString(),
        inputs: getAllInputs(),
        results: {
          lca: appState.lca ? {
            net_kg: appState.lca.net_kg,
            gross_kg: appState.lca.gross_kg,
            breakdown: appState.lca.breakdown,
            massCheck: appState.lca.massCheck
          } : null,
          tea: appState.tea ? { npv: appState.tea.npv } : null,
          sensitivity: appState.sensitivity
        }
      };

      const txt = JSON.stringify(payload, null, 2);
      navigator.clipboard.writeText(txt).then(()=>{
        toast("Copied results to clipboard");
      }).catch(()=>{
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); toast("Copied results to clipboard"); }
        catch(_){ toast("Copy failed (browser restriction)"); }
        ta.remove();
      });
    }

    // ---------------- Sensitivity parameter definitions ----------------
    const SENS_PARAMS = [
      // LCA drivers
      { key:"gridEF",  label:"Grid EF (kg/kWh)", metric:"lca_net" },
      { key:"elecIn",  label:"Electricity in (kWh/FU)", metric:"lca_net" },
      { key:"km",      label:"Transport distance (km)", metric:"lca_net" },
      { key:"truckEF", label:"Truck EF (kg/(t·km))", metric:"lca_net" },
      { key:"heatIn",  label:"Heat in (MJ/FU)", metric:"lca_net" },
      { key:"heatEF",  label:"Heat EF (kg/MJ)", metric:"lca_net" },
      { key:"wGas",    label:"Gas waste (t/FU)", metric:"lca_net" },
      { key:"efGas",   label:"Gas waste EF (kg/t)", metric:"lca_net" },
      { key:"wSolid",  label:"Solid waste (t/FU)", metric:"lca_net" },
      { key:"efSolid", label:"Solid waste EF (kg/t)", metric:"lca_net" },
      { key:"wLiquid", label:"Liquid waste (t/FU)", metric:"lca_net" },
      { key:"efLiquid",label:"Liquid waste EF (kg/t)", metric:"lca_net" },
      { key:"feedIn",  label:"Feedstock in (t/FU)", metric:"lca_net" },
      { key:"elecOut", label:"Exported electricity (kWh/FU)", metric:"lca_net" },
      { key:"heatOut", label:"Exported heat (MJ/FU)", metric:"lca_net" },

      // TEA drivers
      { key:"capex",   label:"CAPEX ($)", metric:"tea_npv" },
      { key:"revenue", label:"Revenue ($/yr)", metric:"tea_npv" },
      { key:"opex",    label:"OPEX ($/yr)", metric:"tea_npv" },
      { key:"discount",label:"Discount rate (%/yr)", metric:"tea_npv" },
      { key:"life",    label:"Project life (yr)", metric:"tea_npv" },
      { key:"salvage", label:"Salvage value ($)", metric:"tea_npv" },
      { key:"wc",      label:"Working capital ($)", metric:"tea_npv" },
    ];

    function useRecommendedSensParams(){
      const metric = $("sensMetric").value;
      const params = SENS_PARAMS.filter(p=>p.metric===metric);
      $("sensParamList").innerHTML = params.map(p=>`• ${p.label} (${p.key})`).join("<br>") || "(none)";
      toast("Parameter list updated");
    }

    function runSensitivity(){
      const metric = $("sensMetric").value;
      const pct = Math.max(0, Number($("sensPct").value || 0)) / 100;
      const topN = Math.max(1, Math.round(Number($("sensTopN").value || 10)));

      if(metric === "lca_net" && (!appState.lca || !Number.isFinite(appState.lca.net_kg))){
        toast("Run LCA first");
        return;
      }
      if(metric === "tea_npv" && (!appState.tea || !Number.isFinite(appState.tea.npv))){
        toast("Run TEA first");
        return;
      }

      const base = getAllInputs();

      const baseMetric =
        metric === "lca_net" ? computeLCAFromInputs(base).net_kg :
        computeTEAFromInputs(base).npv;

      const params = SENS_PARAMS.filter(p=>p.metric === metric);
      $("sensParamList").innerHTML = params.map(p=>`• ${p.label} (${p.key})`).join("<br>");

      const rows = [];
      for(const p of params){
        const x0 = base[p.key];
        if(!Number.isFinite(x0)) continue;

        let lo, hi;
        if(x0 === 0){
          const d = (DEFAULTS && Number.isFinite(DEFAULTS[p.key])) ? DEFAULTS[p.key] : 1;
          const delta = Math.abs(d) * (pct || 0.2);
          lo = x0 - delta;
          hi = x0 + delta;
        } else {
          lo = x0 * (1 - pct);
          hi = x0 * (1 + pct);
        }

        lo = Math.max(0, lo);
        hi = Math.max(0, hi);

        const loInputs = { ...base, [p.key]: lo };
        const hiInputs = { ...base, [p.key]: hi };

        const loMetric =
          metric === "lca_net" ? computeLCAFromInputs(loInputs).net_kg :
          computeTEAFromInputs(loInputs).npv;

        const hiMetric =
          metric === "lca_net" ? computeLCAFromInputs(hiInputs).net_kg :
          computeTEAFromInputs(hiInputs).npv;

        const dLo = loMetric - baseMetric;
        const dHi = hiMetric - baseMetric;

        const impact = Math.max(Math.abs(dLo), Math.abs(dHi));

        rows.push({ key:p.key, label:p.label, lo, hi, dLo, dHi, impact });
      }

      rows.sort((a,b)=>b.impact - a.impact);
      const trimmed = rows.slice(0, topN);

      const unit = metric === "lca_net" ? "kg CO₂e/FU" : "$";
      const baseTxt = metric === "lca_net" ? fmt1.format(baseMetric) : fmt0.format(baseMetric);
      $("sensKPI").innerHTML =
        `Baseline: ${baseTxt} ${unit} <span class="pill">±${Math.round(pct*100)}% one-way</span>`;

      drawSensitivityChart(trimmed, metric, unit);

      appState.sensitivity = {
        metric,
        variation_pct: Math.round(pct*100),
        baseMetric,
        rows: trimmed
      };

      toast("Sensitivity updated");
    }

    function drawSensitivityChart(rows, metric, unit){
      if(sensChart) sensChart.destroy();

      const labels = rows.map(r=>r.label);
      const low = rows.map(r=>r.dLo);
      const high = rows.map(r=>r.dHi);

      const ctx = $("sensChart").getContext("2d");
      sensChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Low (−)", data: low },
            { label: "High (+)", data: high },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const v = c.parsed.x;
                  const pretty = (metric === "lca_net") ? fmt2.format(v) : fmt0.format(v);
                  return `${c.dataset.label}: ${pretty} ${unit} (Δ vs baseline)`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: `Δ ${unit} (vs baseline)` }
            }
          },
          onClick: (evt, elements) => {
            if(!elements || !elements.length) return;
            const e = elements[0];
            const row = rows[e.index];
            const lowTxt = (metric==="lca_net") ? fmt2.format(row.dLo) : fmt0.format(row.dLo);
            const hiTxt  = (metric==="lca_net") ? fmt2.format(row.dHi) : fmt0.format(row.dHi);
            toast(`${row.label}: low Δ ${lowTxt}, high Δ ${hiTxt}`);
          }
        }
      });
    }

    function copySensitivity(){
      if(!appState.sensitivity){
        toast("Run sensitivity first");
        return;
      }
      const txt = JSON.stringify({ owner:"OVO", timestamp:new Date().toISOString(), sensitivity: appState.sensitivity }, null, 2);
      navigator.clipboard.writeText(txt).then(()=>toast("Copied sensitivity to clipboard"))
        .catch(()=>toast("Copy failed (browser restriction)"));
    }

    // Keyboard shortcut: Ctrl/⌘ + Enter runs the relevant model for the active tab
    document.addEventListener("keydown", (ev)=>{
      if((ev.ctrlKey || ev.metaKey) && ev.key === "Enter"){
        if($("lca").classList.contains("active")) runLCA();
        else if($("tea").classList.contains("active")) runTEA();
        else toast("Go to LCA or TEA to run models");
      }
    });

    // ---------------- Init ----------------
    function init(){
      loadSaved();
      attachInputHandlers();
      setActiveTab("lca");
      requestAnimationFrame(()=>$("lca").classList.add("visible"));
      updateAllStatus();
      useRecommendedSensParams();
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
